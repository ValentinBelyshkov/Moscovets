# Логирование в модуле 4 (Биометрия)

## Обзор

В модуль 4 (биометрия) добавлено комплексное логирование для всех этапов работы с 3D моделями, особенно на этапах загрузки и отображения.

## Что добавлено

### 1. Конфигурация логирования

**Файл:** `backend/app/logging_config.py`

- Централизованная настройка логирования для всех компонентов модуля 4
- Раздельные файлы логов для биометрии и моделирования
- Поддержка как консольного, так и файлового вывода
- Автоматическая настройка при импорте модуля

### 2. Логирование в API биометрии

**Файл:** `backend/app/api/v1/biometry.py`

Добавлено логирование для всех операций:

- **Загрузка моделей** (`/upload-obj`):
  - Начало загрузки файла
  - Проверка формата файла
  - Размер загруженного файла
  - Успешное завершение или ошибки

- **Управление точками**:
  - Добавление 3D точек с координатами
  - Добавление картографических точек
  - Создание пар точек
  - Удаление пар точек

- **Статус системы**:
  - Проверка готовности модуля
  - Информация о загруженных моделях

- **Экспорт конфигурации**:
  - Количество экспортируемых пар
  - Путь к файлу экспорта

### 3. Логирование в сервисе хранения

**Файл:** `backend/app/services/biometry_storage.py`

- **Добавление точек**: Детальная информация о координатах
- **Создание пар**: Связь между 3D и картографическими точками
- **Очистка данных**: Количество удаленных элементов
- **Обработка ошибок**: Предупреждения о дубликатах и ошибках

### 4. Логирование в API моделирования

**Файл:** `backend/app/api/v1/endpoints/modeling.py`

- **Загрузка 3D моделей**:
  - Параметры загрузки (пациент, тип модели)
  - Анализ модели (вершины, грани)
  - Сохранение в базу данных

- **Анализ моделей**:
  - Проверка существования файлов
  - Результаты анализа (объем, площадь, дефекты)

- **Просмотр моделей**:
  - Получение списка моделей
  - Детали отдельных моделей

- **Скачивание моделей**:
  - Логирование запросов на скачивание

### 5. Логирование в сервисе Assimp

**Файл:** `backend/app/services/assimp_service.py`

- **Загрузка моделей**:
  - Тип загружаемого файла
  - Обработка сцен с несколькими мешами
  - Вычисление метаданных

- **Анализ моделей**:
  - Вычисление ограничивающей коробки
  - Поиск дефектов (дыры, вырожденные треугольники, нормали)
  - Объем и площадь поверхности

- **Конвертация форматов**:
  - Исходный и целевой форматы
  - Успешное завершение операций

- **Создание окклюзионных накладок**:
  - Загрузка моделей челюстей
  - Поиск контактных поверхностей
  - Параметры создания накладки

- **Булевы операции**:
  - Тип операции (объединение, вычитание, пересечение)
  - Обработка результатов

### 6. Логирование в CRUD операциях

**Файл:** `backend/app/crud/crud_modeling.py`

- **Создание записей**:
  - Параметры создаваемых моделей
  - Пути к файлам
  - Ошибки базы данных

- **Обновление данных**:
  - Изменяемые параметры
  - Старые и новые значения

- **Поиск моделей**:
  - Параметры поиска
  - Количество найденных записей

- **Работа с сессиями**:
  - Создание сессий моделирования
  - Добавление моделей в сессии

### 7. Логирование в основном приложении

**Файл:** `backend/main.py`

- **Запуск приложения**:
  - Инициализация базы данных
  - Настройка CORS
  - Подключение роутеров

## Уровни логирования

- **DEBUG**: Детальная информация о внутренних операциях
- **INFO**: Общая информация о ходе выполнения операций
- **WARNING**: Предупреждения о потенциальных проблемах
- **ERROR**: Ошибки, требующие внимания

## Файлы логов

- `logs/biometry.log` - Логи модуля биометрии
- `logs/modeling.log` - Логи модуля моделирования
- `logs/app.log` - Общие логи приложения

## Примеры логов

### Загрузка модели
```
2025-12-05 13:08:15,123 - app.api.v1.endpoints.modeling - INFO - Starting 3D model upload: upper_jaw.stl, patient_id: 123, type: upper_jaw
2025-12-05 13:08:15,234 - app.services.assimp_service - INFO - Loading 3D model: uploads/3d_models/upper_jaw_123456.stl
2025-12-05 13:08:15,456 - app.services.assimp_service - INFO - Model loaded successfully: uploads/3d_models/upper_jaw_123456.stl, vertices: 15000, faces: 30000, defects: 2
2025-12-05 13:08:15,567 - app.api.v1.endpoints.modeling - INFO - 3D model successfully uploaded with ID: 456
```

### Добавление точек
```
2025-12-05 13:09:20,123 - app.api.v1.biometry - INFO - Adding model point with coordinates: x=10.5, y=20.3, z=5.2
2025-12-05 13:09:20,124 - app.services.biometry_storage - DEBUG - Added model point 1: x=10.5, y=20.3, z=5.2
2025-12-05 13:09:20,125 - app.api.v1.biometry - INFO - Successfully added model point with ID: 1
```

### Создание окклюзионной накладки
```
2025-12-05 13:10:30,123 - app.api.v1.endpoints.modeling - INFO - Creating occlusion pad: upper=uploads/upper.stl, lower=uploads/lower.stl, output=uploads/pad.stl
2025-12-05 13:10:30,234 - app.services.assimp_service - INFO - Loading upper jaw model
2025-12-05 13:10:30,345 - app.services.assimp_service - INFO - Loading lower jaw model
2025-12-05 13:10:30,456 - app.services.assimp_service - DEBUG - Finding contact surface between jaws
2025-12-05 13:10:30,567 - app.services.assimp_service - INFO - Occlusion pad created successfully: uploads/pad.stl
```

## Использование

Для просмотра логов в реальном времени:

```bash
# Просмотр логов биометрии
tail -f logs/biometry.log

# Просмотр логов моделирования
tail -f logs/modeling.log

# Просмотр общих логов
tail -f logs/app.log
```

## Особенности

1. **Безопасность**: Логи не содержат чувствительной информации о пациентах
2. **Производительность**: Логирование не влияет на производительность основных операций
3. **Гибкость**: Возможность настройки уровней логирования для разных компонентов
4. **Отладка**: Подробные логи помогают в диагностике проблем и отладке

## Требования

- Python 3.8+
- FastAPI
- SQLAlchemy
- trimesh
- pydantic

## Поддержка

Для вопросов и предложений по улучшению логирования обращайтесь к разработчикам модуля 4.