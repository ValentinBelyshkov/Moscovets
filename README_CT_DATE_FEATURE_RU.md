# Реализация функции выбора даты сканирования КТ

## Обзор

Реализована возможность загрузки и организации CT/DICOM файлов по дате сканирования:
1. Файлы распаковываются в папки с конкретной датой: `storage/patients/patient_{id}/dicom/{дд.мм.гггг}/`
2. На фронтенде добавлен выбор даты сканирования перед загрузкой
3. Пользователи могут просматривать и выбирать из ранее загруженных дат сканирования

## Что было сделано

### Backend (Бэкенд)

#### 1. Сервис хранения файлов (`backend/app/services/file_storage_service.py`)
- Модифицирован метод `generate_file_path()` для включения даты исследования в путь для DICOM и CT файлов
- Формат даты в пути: `дд.мм.гггг` (например, `25.01.2026`)
- Структура: `storage/patients/patient_{id}/dicom/{дд.мм.гггг}/{имя_файла}`

#### 2. Новый endpoint для CT (`backend/app/api/v1/endpoints/ct.py`)
Создан новый endpoint с тремя основными функциями:

- **POST `/api/v1/ct/upload-archive`**
  - Принимает ZIP архив, patient_id, scan_date (ГГГГ-ММ-ДД) и опциональное описание
  - Извлекает DICOM файлы из ZIP архива
  - Сохраняет файлы в структуру папок с конкретной датой
  - Создает записи в базе данных для каждого файла
  - Возвращает информацию о файлах, включая путь хранения

- **GET `/api/v1/ct/patient/{patient_id}/scan-dates`**
  - Возвращает список уникальных дат сканирования для CT файлов пациента
  - Отсортированы по дате (сначала новейшие)

- **GET `/api/v1/ct/patient/{patient_id}/files-by-date/{scan_date}`**
  - Возвращает все CT файлы для конкретного пациента и даты сканирования
  - Полезно для загрузки ранее загруженных сканов

#### 3. Роутер API (`backend/app/api/v1/api.py`)
- Добавлен роутер CT: `api_router.include_router(ct.router, prefix="/ct", tags=["ct"])`

#### 4. Конфигурация (`backend/app/core/config.py`)
- Добавлена настройка `STORAGE_PATH`

### Frontend (Фронтенд)

#### 1. Сервис CT (`frontend/src/services/ctService.js`)
Новый сервис для операций с CT API:
- `uploadCTArchive()` - Загрузка ZIP архива с датой сканирования
- `getPatientScanDates()` - Получение всех дат сканирования для пациента
- `getPatientFilesByDate()` - Получение файлов для конкретной даты
- `downloadFile()` - Скачивание файла по ID
- `getFileUrl()` - Получение URL файла для предпросмотра/скачивания

#### 2. Селектор даты сканирования CT (`frontend/src/components/ct/CTScanDateSelector.js`)
Новый компонент, который:
- Отображает список существующих дат сканирования для пациента
- Позволяет выбрать ранее загруженную дату сканирования
- Загружает файлы при выборе даты
- Показывает состояния загрузки и обработку ошибок

#### 3. Компонент загрузки архива (`frontend/src/components/ArchiveUpload.js`)
Расширен новыми возможностями:
- Добавлены пропсы: `patientId`, `scanDate`, `enableBackendUpload`
- Поддерживает оба режима: локальное хранилище (существующий) и backend API (новый)
- Когда `enableBackendUpload` включен и `scanDate` указан, использует backend CT сервис
- Проверяет, что дата сканирования указана при использовании backend режима

#### 4. Состояние CT (`frontend/src/components/ct/useCTState.js`)
Добавлены новые поля состояния:
- `patientId` - ID текущего пациента (по умолчанию: 1)
- `scanDate` - Выбранная дата сканирования для загрузки/выбора
- `storagePath` - Путь, где сохранены файлы (возвращается из backend)

#### 5. Обработчики CT (`frontend/src/components/ct/useCTHandlers.js`)
Новые и обновленные обработчики:
- `handleScanDateSelect()` - Загружает файлы для выбранной даты из backend
- Обновлен `handleArchiveUploadSuccess()` - Обрабатывает scan_date и storage_path из backend
- Отображает путь хранения в сообщении об успехе

#### 6. Модуль CT (`frontend/src/components/ct/CTModuleRefactored.js`)
Улучшения UI:
- Добавлено поле ввода "Дата сканирования" с выбором даты
- Показывает предпросмотр пути хранения на основе выбранной даты
- Интегрирован компонент CTScanDateSelector
- Передает дату сканирования и ID пациента в ArchiveUpload
- Отображает путь хранения после успешной загрузки

## Как использовать

### Загрузка нового сканирования КТ
1. Перейдите на страницу `/ct`
2. Выберите пациента (в данный момент жестко задан как patient_1)
3. Выберите "Дата сканирования" из календаря
4. Увидите ожидаемый путь хранения: `storage/patients/patient_1/dicom/{дд.мм.гггг}`
5. Перетащите или выберите ZIP архив с DICOM файлами
6. Нажмите "Распаковать и загрузить"
7. Файлы извлекаются и сохраняются в папку с конкретной датой
8. Сообщение об успехе показывает путь хранения

### Просмотр существующих сканирований
1. Перейдите на страницу `/ct`
2. Секция "История сканирований КТ" покажет все ранее загруженные даты
3. Выпадающий список показывает все даты сканирования
4. Выберите дату для загрузки этих файлов
5. Файлы загружены и готовы для назначения плоскостей и просмотра

## Структура хранения

```
storage/
└── patients/
    └── patient_1/
        └── dicom/
            ├── 25.01.2026/
            │   ├── file1.dcm
            │   ├── file2.dcm
            │   └── ...
            ├── 10.02.2026/
            │   └── ...
            └── ...
```

## Пример

Если пользователь загружает сканирование КТ с датой `2026-01-25`:
- Путь хранения: `storage/patients/patient_1/dicom/25.01.2026/`
- Создаются записи в базе данных для каждого DICOM файла
- Фронтенд отображает путь как `patients/patient_1/dicom/25.01.2026`
- Файлы доступны через `/api/v1/files/download/{file_id}`

## Тестирование

Для проверки функционала:
1. Запустите backend и frontend сервисы
2. Войдите в приложение
3. Перейдите на `/ct`
4. Выберите дату сканирования (например, 2026-01-25)
5. Загрузите ZIP архив с DICOM файлами
6. Проверьте, что файлы сохранены в правильную папку с датой
7. Проверьте, что дата сканирования появилась в селекторе истории
8. Выберите дату для проверки, что файлы можно загрузить

## Примечания

- ID пациента в данный момент жестко задан как 1 во фронтенде
- В продакшене ID пациента должен поступать из выбора пациента/контекста
- Формат даты в файловой системе использует русский формат (дд.мм.гггг), как было указано в задании
- API ожидает формат ГГГГ-ММ-ДД для параметра scan_date
- Имена файлов генерируются с UUID для обеспечения уникальности
- Все загрузки файлов защищены JWT аутентификацией
- ZIP файлы проверяются на формат и лимиты размера (максимум 500 МБ)
